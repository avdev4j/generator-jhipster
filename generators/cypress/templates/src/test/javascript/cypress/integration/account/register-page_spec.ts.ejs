import {
    usernameRegisterSelector,
    emailRegisterSelector,
    firstPasswordRegisterSelector,
    secondPasswordRegisterSelector,
    submitRegisterSelector } from '../../support/commands';

  describe('/account/register', () => {
    beforeEach(() => {
      cy.server();
      cy.route('POST', '/api/register').as('registerSave');
    });

    before(() => {
      cy.window().then((win) => {
        win.sessionStorage.clear()
      });
      cy.visit('');
      cy.clickOnRegisterItem();
    });

    it('should load the register page', () => {
      cy.get(submitRegisterSelector).should('be.visible');
    });

    it('requires username', () => {
      cy.get(usernameRegisterSelector)
        .should('have.class', 'invalid')
        .type('test')
        .should('have.class', 'valid')
        .clear();
    });

    it('requires email', () => {
      cy.get(emailRegisterSelector)
        .should('have.class', 'invalid')
        .type('testtest.fr')
        .should('have.class', 'invalid')
        .clear();
    });

    it('requires email in correct format', () => {
      cy.get(emailRegisterSelector)
        .should('have.class', 'invalid')
        .type('test@test.fr')
        .should('have.class', 'valid')
        .clear();
    });

    it('requires first password', () => {
      cy.get(firstPasswordRegisterSelector)
        .should('have.class', 'invalid')
        .type('test@test.fr')
        .should('have.class', 'valid')
        .clear();
    });

    it('requires password and confirm password to be same', () => {
      cy.get(firstPasswordRegisterSelector)
        .should('have.class', 'invalid')
        .type('test')
        .should('have.class', 'valid');

      cy.get(secondPasswordRegisterSelector)
        .should('have.class', 'invalid')
        .type('test')
        .should('have.class', 'valid');

      cy.get(firstPasswordRegisterSelector).clear();
      cy.get(secondPasswordRegisterSelector).clear();
    });

    it('requires password and confirm password have not the same value', () => {
      cy.get(firstPasswordRegisterSelector)
        .should('have.class', 'invalid')
        .type('test')
        .should('have.class', 'valid');

      cy.get(secondPasswordRegisterSelector)
        .should('have.class', 'invalid')
        .type('otherPassword')
        .should('have.class', 'invalid');

      cy.get(firstPasswordRegisterSelector).clear();
      cy.get(secondPasswordRegisterSelector).clear();
    });

    it('register a valid user', () => {
      cy.get(usernameRegisterSelector).type('jon_doe');
      cy.get(emailRegisterSelector).type('jondoe@localhost.com');
      cy.get(firstPasswordRegisterSelector).type('jondoe');
      cy.get(secondPasswordRegisterSelector).type('jondoe');
      cy.get(submitRegisterSelector).click();
      cy.wait('@registerSave').its('status').should('equal', 201);
    });

    it('error for existing user', () => {
      cy.visit('');
      cy.clickOnRegisterItem();
      cy.get(usernameRegisterSelector).type('admin');
      cy.get(emailRegisterSelector).type('admin@localhost.com');
      cy.get(firstPasswordRegisterSelector).type('admin');
      cy.get(secondPasswordRegisterSelector).type('admin');
      cy.get(submitRegisterSelector).click();
      cy.wait('@registerSave').its('status').should('equal', 400);
    });
  });
